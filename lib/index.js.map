{"version":3,"sources":["../src/index.js"],"names":["BbPromise","require","path","LayersService","BucketService","CloudFormationService","ZipService","Dependencies","ServerlessLayers","serverless","options","cacheObject","provider","getProvider","service","region","getRegion","log","bind","main","version","getVersion","replace","process","exit","hooks","then","init","finalizeDeploy","settings","getSettings","zipService","dependencies","layersService","bucketService","cloudFormationService","localpackageJson","join","env","PWD","packagePath","localPackage","e","inboundSettings","custom","defaultSettings","packageManager","compileDir","compatibleRuntimes","layersDeploymentBucket","deploymentBucket","Object","assign","downloadPackageJson","remotePackage","isDifferent","isDiff","getLayerArn","currentLayerARN","relateLayerWithFunctions","install","package","uploadZipFile","publishVersion","uploadPackageJson","LayerVersionArn","stage","Error","cwd","getStackName","serviceStage","deploymentPrefix","getDeploymentPrefix","getOutputs","outputs","logicalId","getOutputLogicalId","find","x","OutputKey","OutputValue","naming","getLambdaLayerOutputLogicalId","layerArn","functions","keys","forEach","funcName","layers","push","resources","Outputs","outputName","Value","Export","Name","depsA","depsB","depsKeyA","depsKeyB","isSizeEqual","length","hasDifference","dependence","map","msg","cli","module","exports"],"mappings":"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","sourcesContent":["const BbPromise = require('bluebird');\nconst path = require('path');\n\nconst LayersService = require('./aws/LayersService');\nconst BucketService = require('./aws/BucketService');\nconst CloudFormationService = require('./aws/CloudFormationService');\nconst ZipService = require('./package/ZipService');\nconst Dependencies = require('./package/Dependencies');\n\nclass ServerlessLayers {\n  constructor(serverless, options) {\n    this.cacheObject = {};\n    this.options = options;\n    this.serverless = serverless;\n\n    this.provider = serverless.getProvider('aws');\n    this.service = serverless.service;\n    this.options.region = this.provider.getRegion();\n\n    // bindings\n    this.log = this.log.bind(this);\n    this.main = this.main.bind(this);\n\n    const version = serverless.getVersion().replace(/\\./g, '');\n\n    if (version < 1340) {\n      this.log(`Error: Please install serverless >= 1.34.0 (current ${serverless.getVersion()})`)\n      process.exit(1);\n    }\n\n    // hooks\n    this.hooks = {\n      'before:package:initialize': () => BbPromise.bind(this)\n        .then(() => this.init()),\n      'package:initialize': () => BbPromise.bind(this)\n        .then(() => this.main()),\n      'aws:info:displayLayers': () => BbPromise.bind(this)\n        .then(() => this.finalizeDeploy())\n    };\n  }\n\n  async init() {\n    this.settings = this.getSettings();\n\n    this.zipService = new ZipService(this);\n    this.dependencies = new Dependencies(this);\n    this.layersService = new LayersService(this);\n    this.bucketService = new BucketService(this);\n    this.cloudFormationService = new CloudFormationService(this);\n\n    const localpackageJson = path.join(\n      process.env.PWD,\n      this.settings.packagePath\n    );\n\n    try {\n      this.localPackage = require(localpackageJson);\n    } catch (e) {\n      this.log(`Error: Can not find ${localpackageJson}!`);\n      process.exit(1);\n    }\n  }\n\n  getSettings() {\n    const inboundSettings = (this.serverless.service.custom || {})[\n      'serverless-layers'\n    ];\n    const defaultSettings = {\n      packageManager: 'npm',\n      compileDir: '.serverless',\n      packagePath: 'package.json',\n      compatibleRuntimes: ['nodejs'],\n      layersDeploymentBucket: this.service.provider.deploymentBucket\n    };\n    return Object.assign({}, defaultSettings, inboundSettings);\n  }\n\n  async main() {\n    const remotePackage = await this.bucketService.downloadPackageJson();\n\n    let isDifferent = true;\n    if (remotePackage) {\n      this.log('Comparing package.json dependencies...');\n      isDifferent = await this.isDiff(remotePackage.dependencies, this.localPackage.dependencies);\n    }\n\n    const currentLayerARN = await this.getLayerArn();\n    if (!isDifferent && currentLayerARN) {\n      this.log(`Not has changed! Using same layer arn: ${currentLayerARN}`);\n      this.relateLayerWithFunctions(currentLayerARN);\n      return;\n    }\n\n    await this.dependencies.install()\n    await this.zipService.package();\n    await this.bucketService.uploadZipFile();\n    const version = await this.layersService.publishVersion();\n    await this.bucketService.uploadPackageJson();\n\n    this.relateLayerWithFunctions(version.LayerVersionArn);\n  }\n\n  getStackName() {\n    return `${this.serverless.service.service}-${this.options.stage}`;\n  }\n\n  getBucketName() {\n    if (!this.settings.layersDeploymentBucket) {\n      throw new Error(\n        'Please, you should specify \"deploymentBucket\" or \"layersDeploymentBucket\" option for this plugin!\\n'\n      );\n    }\n    return this.settings.layersDeploymentBucket;\n  }\n\n  getPathZipFileName() {\n    return `${path.join(process.cwd(), this.settings.compileDir, this.getStackName())}.zip`;\n  }\n\n  getBucketLayersPath() {\n    const serviceStage = `${this.serverless.service.service}/${this.options.stage}`;\n\n    let deploymentPrefix = 'serverless';\n    if (this.provider.getDeploymentPrefix) {\n      deploymentPrefix = this.provider.getDeploymentPrefix();\n    }\n\n    return path.join(\n      deploymentPrefix,\n      serviceStage,\n      'layers'\n    );\n  }\n\n  async getLayerArn() {\n    if (this.cacheObject.LayerVersionArn) {\n      return this.cacheObject.LayerVersionArn;\n    }\n    const outputs = await this.cloudFormationService.getOutputs();\n    if (!outputs) return null;\n    const logicalId = this.getOutputLogicalId();\n    return (outputs.find(x => x.OutputKey === logicalId) || {}).OutputValue;\n  }\n\n  getOutputLogicalId() {\n    return this.provider.naming.getLambdaLayerOutputLogicalId(this.getStackName());\n  }\n\n  relateLayerWithFunctions(layerArn) {\n    this.log('Associating layers...');\n\n    const { functions } = this.service;\n\n    Object.keys(functions).forEach(funcName => {\n      functions[funcName].layers = functions[funcName].layers || [];\n      functions[funcName].layers.push(layerArn);\n      this.log(`function.${funcName} - ${layerArn}`);\n    });\n\n    this.service.resources = this.service.resources || {};\n    this.service.resources.Outputs = this.service.resources.Outputs || {};\n\n    const outputName = this.getOutputLogicalId();\n\n    Object.assign(this.service.resources.Outputs, {\n      [outputName]: {\n        Value: layerArn,\n        Export: {\n          Name: outputName\n        }\n      }\n    });\n  }\n\n  isDiff(depsA, depsB) {\n    const depsKeyA = Object.keys(depsA);\n    const depsKeyB = Object.keys(depsB);\n    const isSizeEqual = depsKeyA.length === depsKeyB.length;\n\n    if (!isSizeEqual) return true;\n\n    let hasDifference = false;\n    Object.keys(depsA).forEach(dependence => {\n      if (depsA[dependence] !== depsB[dependence]) {\n        hasDifference = true;\n      }\n    });\n\n    return hasDifference;\n  }\n\n  getDependenciesList() {\n    return Object.keys((this.localPackage.dependencies||[])).map(x => (\n      `${x}@${this.localPackage.dependencies[x]}`\n    ));\n  }\n\n  async finalizeDeploy() {\n    const currentLayerARN = await this.getLayerArn();\n    Object.keys(this.service.functions).forEach(funcName => {\n      this.log(`function.${funcName} = layers.${currentLayerARN}`);\n    });\n  }\n\n  log(msg) {\n    this.serverless.cli.log(`[LayersPlugin]: ${msg}`);\n  }\n}\n\nmodule.exports = ServerlessLayers;\n"],"file":"index.js"}