{"version":3,"sources":["../src/index.js"],"names":["BbPromise","require","path","LayersService","BucketService","CloudFormationService","ZipService","Dependencies","ServerlessLayers","serverless","options","cacheObject","provider","getProvider","service","region","getRegion","log","bind","main","hooks","then","init","finalizeDeploy","settings","getSettings","zipService","dependencies","layersService","bucketService","cloudFormationService","localpackageJson","join","process","env","PWD","packagePath","localPackage","e","exit","inboundSettings","custom","defaultSettings","compileDir","layersDeploymentBucket","deploymentBucket","Object","assign","downloadPackageJson","remotePackage","isDifferent","isDiff","getLayerArn","currentLayerARN","relateLayerWithFunctions","install","package","uploadZipFile","publishVersion","version","uploadPackageJson","LayerVersionArn","stage","Error","cwd","getStackName","serviceStage","getDeploymentPrefix","getOutputs","outputs","logicalId","getOutputLogicalId","find","x","OutputKey","OutputValue","naming","getLambdaLayerOutputLogicalId","layerArn","functions","keys","forEach","funcName","layers","push","resources","Outputs","outputName","Value","Export","Name","depsA","depsB","depsKeyA","depsKeyB","isSizeEqual","length","hasDifference","dependence","map","msg","cli","module","exports"],"mappings":"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","sourcesContent":["const BbPromise = require('bluebird');\nconst path = require('path');\n\nconst LayersService = require('./aws/LayersService');\nconst BucketService = require('./aws/BucketService');\nconst CloudFormationService = require('./aws/CloudFormationService');\nconst ZipService = require('./package/ZipService');\nconst Dependencies = require('./package/Dependencies');\n\nclass ServerlessLayers {\n  constructor(serverless, options) {\n    this.cacheObject = {};\n    this.options = options;\n    this.serverless = serverless;\n\n    this.provider = serverless.getProvider('aws');\n    this.service = serverless.service;\n    this.options.region = this.provider.getRegion();\n\n\n    // bindings\n    this.log = this.log.bind(this);\n    this.main = this.main.bind(this);\n\n    // hooks\n    this.hooks = {\n      'before:package:initialize': () => BbPromise.bind(this)\n        .then(() => this.init()),\n      'package:initialize': () => BbPromise.bind(this)\n        .then(() => this.main()),\n      'aws:info:displayLayers': () => BbPromise.bind(this)\n        .then(() => this.finalizeDeploy())\n    };\n  }\n\n  async init() {\n    this.settings = this.getSettings();\n\n    this.zipService = new ZipService(this);\n    this.dependencies = new Dependencies(this);\n    this.layersService = new LayersService(this);\n    this.bucketService = new BucketService(this);\n    this.cloudFormationService = new CloudFormationService(this);\n\n    const localpackageJson = path.join(\n      process.env.PWD,\n      this.settings.packagePath\n    );\n\n    try {\n      this.localPackage = require(localpackageJson);\n    } catch (e) {\n      this.log(`Error: Can not find ${localpackageJson}!`);\n      process.exit(1);\n    }\n  }\n\n  getSettings() {\n    const inboundSettings = (this.serverless.service.custom || {})[\n      'serverless-layers'\n    ];\n    const defaultSettings = {\n      compileDir: '.serverless',\n      packagePath: 'package.json',\n      layersDeploymentBucket: this.service.provider.deploymentBucket\n    };\n    return Object.assign({}, defaultSettings, inboundSettings);\n  }\n\n  async main() {\n    const remotePackage = await this.bucketService.downloadPackageJson();\n\n    let isDifferent = true;\n    if (remotePackage) {\n      this.log('Comparing package.json dependencies...');\n      isDifferent = await this.isDiff(remotePackage.dependencies, this.localPackage.dependencies);\n    }\n\n    const currentLayerARN = await this.getLayerArn();\n\n    if (!isDifferent && currentLayerARN) {\n      this.log(`Not has changed! Using same layer arn: ${currentLayerARN}`);\n      this.relateLayerWithFunctions(currentLayerARN);\n      return;\n    }\n\n    await this.dependencies.install()\n    await this.zipService.package();\n    await this.bucketService.uploadZipFile();\n    const version = await this.layersService.publishVersion();\n    await this.bucketService.uploadPackageJson();\n\n    this.relateLayerWithFunctions(version.LayerVersionArn);\n  }\n\n  getStackName() {\n    return `${this.serverless.service.service}-${this.options.stage}`;\n  }\n\n  getBucketName() {\n    if (!this.settings.layersDeploymentBucket) {\n      throw new Error(\n        'Please, you should specify \"deploymentBucket\" for this plugin!\\n'\n      );\n    }\n    return this.settings.layersDeploymentBucket;\n  }\n\n  getPathZipFileName() {\n    return `${path.join(process.cwd(), this.settings.compileDir, this.getStackName())}.zip`;\n  }\n\n  getBucketLayersPath() {\n    const serviceStage = `${this.serverless.service.service}/${this.options.stage}`;\n    return path.join(\n      this.provider.getDeploymentPrefix(),\n      serviceStage,\n      'layers'\n    );\n  }\n\n  async getLayerArn() {\n    if (this.cacheObject.LayerVersionArn) {\n      return this.cacheObject.LayerVersionArn;\n    }\n    const outputs = await this.cloudFormationService.getOutputs();\n    if (!outputs) return null;\n    const logicalId = this.getOutputLogicalId();\n    return (outputs.find(x => x.OutputKey === logicalId) || {}).OutputValue;\n  }\n\n  getOutputLogicalId() {\n    return this.provider.naming.getLambdaLayerOutputLogicalId(this.getStackName());\n  }\n\n  relateLayerWithFunctions(layerArn) {\n    this.log('Associating layers...');\n\n    const { functions } = this.service;\n\n    Object.keys(functions).forEach(funcName => {\n      functions[funcName].layers = functions[funcName].layers || [];\n      functions[funcName].layers.push(layerArn);\n      this.log(`function.${funcName} - ${layerArn}`);\n    });\n\n    this.service.resources = this.service.resources || {};\n    this.service.resources.Outputs = this.service.resources.Outputs || {};\n\n    const outputName = this.getOutputLogicalId();\n\n    Object.assign(this.service.resources.Outputs, {\n      [outputName]: {\n        Value: layerArn,\n        Export: {\n          Name: outputName\n        }\n      }\n    });\n  }\n\n  isDiff(depsA, depsB) {\n    const depsKeyA = Object.keys(depsA);\n    const depsKeyB = Object.keys(depsB);\n    const isSizeEqual = depsKeyA.length === depsKeyB.length;\n\n    if (!isSizeEqual) return true;\n\n    let hasDifference = false;\n    Object.keys(depsA).forEach(dependence => {\n      if (depsA[dependence] !== depsB[dependence]) {\n        hasDifference = true;\n      }\n    });\n\n    return hasDifference;\n  }\n\n  getDependenciesList() {\n    return Object.keys(this.localPackage.dependencies).map(x => (\n      `${x}@${this.localPackage.dependencies[x]}`\n    ));\n  }\n\n  async finalizeDeploy() {\n    const currentLayerARN = await this.getLayerArn();\n    Object.keys(this.service.functions).forEach(funcName => {\n      this.log(`function.${funcName} = layers.${currentLayerARN}`);\n    });\n  }\n\n  log(msg) {\n    this.serverless.cli.log(`[LayersPlugin]: ${msg}`);\n  }\n}\n\nmodule.exports = ServerlessLayers;\n"],"file":"index.js"}